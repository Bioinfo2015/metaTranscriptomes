##comparing CpG across transcriptomes

#------------- FIRST SEP, DOWNLOAD THE TRANSCRIPTOMES ----------
#download nucleotide sequences from variatious sources. See transcriptomeSpreadsheet.xlsx

#Aiptasia from Pringle lab
wget "http://pringlelab.stanford.edu/project%20files/SymTranscriptsClustered_id_99_frac_20_seeds_rereunRev%20(2).fa.gz" #Aiptasia

#Meyer lab transcriptomes
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/MaurN/Maur_transcriptome_v1.fasta.gz" #Madracis auretenra
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/DstrN/Pstr_transcriptome_v1.fasta.gz" #Pseudodiploria strigosa
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Fscu/Fscu_transcriptome_v1.fasta.gz" #Fungia scutaria
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Shys/Shys_transcriptome_v1.fasta.gz" #Seriatopora hystrix
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Mcav/Mcav_transcriptome_v1.fasta.gz" #Montastaea cavernosa
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Aele/Aele_transcriptome_v1.fasta.gz" #Anthopleura elegantissima

#Matz lab transcriptomes
wget "https://dl.dropboxusercontent.com/u/37523721/amillepora_transcriptome_july2014.zip" #Acropora millepora (by Moya)
wget "https://dl.dropboxusercontent.com/u/37523721/ahyacinthus_transcriptome_july2014.zip" #Acropora hyacinthus
wget "https://dl.dropboxusercontent.com/u/37523721/pastreoides_transcriptome_july2014.zip" #Porites asteoides
wget "https://dl.dropboxusercontent.com/u/37523721/atenuis_transcriptome_july2014.zip" #Acropora tenuis

#OIST Marine Genomics Unit
wget "http://marinegenomics.oist.jp/genomes/download/adi_transcriptome_assembly.v1.fa.gz" #Acropora digitifera transcriptome
wget "http://marinegenomics.oist.jp/genomes/download/adi_v1.0.1.prot.fa.gz" #Acropora digitifera proteome

#Cnidarian Database
wget "http://data.centrescientifique.mc/Data/454Isotigs.fas.zip" #Stylophora pistillata (Karako-Lampert et al. Plos One 2014)

#PocilloporaBase
wget "http://cnidarians.bu.edu/PocilloporaBase/cgi-bin/blast/contigs.fan" #Pocillopora damicornis

#Baums Lab
wget "https://usegalaxy.org/datasets/cb51c4a06d7ae94e/display?to_ext=fasta" #Acropora palmata (Polato et al. 2011)

#PcarnBase
wget "http://www.comp.hkbu.edu.hk/~db/PcarnBase/db/nucleotide/CoralDNA" #Platygyra carnosus (Sun et al 2013) Couldn't get this one to work anymore

# getting uniprot database
echo "wget ftp://ftp.uniprot.org/pub/databases/uniprot/uniref/uniref50/uniref50.fasta.gz" >getuni 
GDlauncher_creator.py -j getuni -n unipr -l uu -q normal -t 4:00:00 -a tagmap
qsub uu

# getting GO annotations
echo "wget ftp://ftp.uniprot.org/pub/databases/uniprot/current_release/knowledgebase/idmapping/idmapping_selected.tab.gz" >getgo
GDlauncher_creator.py -j getgo -n getgo -l gg -q normal -t 4:00:00 -a tagmap
qsub gg

# unzipping
gunzip uniref50.fasta.gz &
gunzip idmapping_selected.tab.gz &

#download the N.vectensis and A.digitifera protein sequence references

#BUILD JOINT CNIDARIAN DATABASE FROM  N.vectensis and A.digitifera PROTEOMES

wget "ftp://ftp.jgi-psf.org/pub/JGI_data/Nematostella_vectensis/v1.0/annotation/transcripts.Nemve1FilteredModels1.fasta.gz" #Nematostella transcriptome
wget "ftp://ftp.jgi-psf.org/pub/JGI_data/Nematostella_vectensis/v1.0/annotation/proteins.Nemve1FilteredModels1.fasta.gz" #Nematostella protein sequences
cat /work/02260/grovesd/digitifera/proteome/Acropora_digitifera_peptides_100.final.clstr.faa /work/02260/grovesd/Nvectensis_references/Nvectensis_protSeqs.fasta > cnidarianProteinDB.fasta

# indexing the fasta database
module load blast
echo "makeblastdb -in cnidarianProteinDB.fasta -dbtype prot" >mdb
GDlauncher_creator.py -j mdb -n mdb -l mmm -a tagmap
qsub mmm

#set up a variable for the pathway to the uniprot files
UNIPROT="/work/02260/grovesd/uniprot_files/mishaAnnotations/uniref50.fasta"
CIDARIANDB="/work/02260/grovesd/Nvectensis_references/cnidarianProteinDB.fasta"

#SHOULD CHANGE SUFFIX TO FAS TO FIT MISHA'S OUTPUT

#blast against the Cnidarian (dig + Nemato) database--since this is a small db you can just run them all at once
for file in $(ls *.fa); do echo blastx -query $file -db $CIDARIANDB -evalue 1e-5 -num_threads 12 -num_descriptions 5 -num_alignments 5 -out ${file/.fa/}.br >> doblast; done
GDlauncher_creator.py -j doblast -n doblast -l doblast.job -a tagmap -q normal -t 24:00:00 
qsub doblast.job

#run CDS extractor for each transcriptome
#note this doesn't seem to like overwriting files, so remove them if you are running multiple times.
module load bioperl
>extract; for s in `cat speciesList.txt`; do echo "CDS_extractor_v2.pl $s.fa $s.br" >> extract ; done
GDlauncher_creator.py -j extract -n extract -l extract0.job -a tagmap
cat extract0.job | perl -pe 's/12way .+$/12way 24/' > extract.job ; rm extract0.job
qsub extract.job

##see if you got back sequences for all of them
ll *CDS.fas | wc -l

######## GETTING CPG DATA #########

##extract CpG data from a subset of the coding regions
> getcpg; for s in `cat speciesList.txt`; do echo newGetCpGoe.py -i $s\_CDS.fas -sub 1000 -o $s\CpG.txt >> getcpg; done
GDlauncher_creator.py -j getcpg -n getcpg -l getcpg.job -a tagmap
qsub getcpg.job

##scp them to Mac for R work
##build a new species list in case some have dropped
>speciesList.txt; for file in $(ls *CpG.txt); do echo ${file/CpG.txt/} >> speciesList.txt; done


##============== GETTING RECIPROCAL ORTHOLOGS ========================================
#make blast databases from each _CDS.fas file
module load blast
> makeDBs; for file in $(ls *PRO.fas); do  echo makeblastdb -in $file -dbtype prot >> makeDBs; done
launcher_creator.py -j makeDBs -n makeDBs -l makeDBs.job -e grovesdixon@gmail.com -a tagmap
qsub makeDBs.job

#blast each set of extracted protein sequence to the CNIDARIAN database and do the reciprocal blast
#set up the command file

>blastps
for file in $(ls *.fas); do echo blastp -query $file -db $CIDARIANDB -evalue 1e-5 -num_threads 12 -num_alignments 1 -outfmt 5 -out ${file/_PRO.fas/_2_CNIDB.br} >> blastps
echo blastp -query $CIDARIANDB -db $file -evalue 1e-5 -num_threads 12 -num_alignments 1 -outfmt 5 -out CNIDB_2_${file/_PRO.fas/.br} >> blastps
done

GDlauncher_creator.py -n blastps -j blastps -l blastps0.job -q normal -a tagmap -t 10:00:00
cat blastps0.job | perl -pe 's/12way .+$/12way 24/' > blastps.job ; rm blastps0.job
qsub blastps.job

##pull the reciprocal orthologs using the CNIDB seq names to output (simply swap out which is fa1 and br1
>getOrthos2; for file in $(ls *PRO.fas); do echo get_reciprocal_orthos.py -br2 ${file/_PRO.fas/}_2_CNIDB.br -br1 CNIDB_2_${file/_PRO.fas}.br -fa2 $file -fa1 $CIDARIANDB -o ./CNID_${file/_PRO.fas/}_orthos.txt -e 1e-20 -hp 75 >> getOrthos2; done
GDlauncher_creator.py -n getOrthos2 -j getOrthos2 -l getOrthos2_.job
cat getOrthos2_.job | perl -pe 's/12way .+$/12way 12/' > getOrthos2.job ; rm getOrthos2_.job
qsub getOrthos2.job

#OPTIONALLY:
##if you needed them coded the other way, get the reciprocal orthologs and output based on the transcriptome sequence names using get_reciprocal_orthos.py
>getOrthos; for file in $(ls *PRO.fas); do echo get_reciprocal_orthos.py -br1 ${file/_PRO.fas/}_2_CNIDB.br -br2 CNIDB_2_${file/_PRO.fas}.br -fa1 $file -fa2 $CIDARIANDB -o ${file/_PRO.fas/}_orthos.txt -e 1e-20 -hp 75 >> getOrthos; done
GDlauncher_creator.py -n getOrthos -j getOrthos -l getOrthos.job
qsub getOrthos.job

##Assemble the full table of ortholog pairs
mergeReciprocalOrthos.py -f CNID*orthos.txt -c 1 -o orthologs.txt

##========== MAKE ALIGNMENTS OF THE ORTHOLOGS ============================



##now assemble the protein and nucleotide fastas for each species that you want to use into a directory
echo output_ortholog_seqs.py -orthos orthologs.txt -prot *PRO.fas -nucl *CDS.fas > orthoOuter
GDlauncher_creator.py -j orthoOuter -n orthoOuter -l orthoOuter.job -q development
qsub orthoOuter.job


#now run the alignments
for fa in $(ls *prot.fasta); do mafft --auto --maxiterate 1000 $fa > ${fa/.fasta/}.aln; done


##now get codon seqs for each alignment using pal2nal.pl
for aln in $(ls *.aln); do pal2nal.pl $aln ${aln/prot.aln/}nuc.fasta -output paml -nogap > ${aln/_prot.aln/}.codon; done

#if you want you can print all the codon files to your screen with this
for f in $(ls *.codon); do cat $f; echo; echo; echo; done



#now you have each sequence as codons. Now you need a Nexus file to run beast from 
#first get a new species list
>speciesList.txt; for file in $(ls *PRO.fas); do echo ${file/_PRO.fas/} >> speciesList.txt; done

#now run the script concatenate_genes_for_beast.py to build the nexus file
concatenate_genes_for_beast.py -spp speciesList.txt -f *.codon -o sequences.nex

#scp the file output from concatenate_genes_for_beast.py to Mac to run Beast
#see 'RunningBest.txt' for instructions



##now run paml for each file
##use this to run on front nodes
for file in $(ls *.codon); do build_paml_control.py $file > ${file/.codon/}.cnt; codeml ${file/.codon/}.cnt; done

#use this to que a job
>runpaml;for file in $(ls *.codon); do echo "build_paml_control.py $file > ${file/.codon/}.cnt" >> runpaml; echo "codeml ${file/.codon/}.cnt" >> runpaml; done
launcher_creator.py -j runpaml -n runpaml -l runpaml0.job -e grovesdixon@gmail.com -a tagmap
cat runpaml0.job | perl -pe 's/12way .+$/1way 12/' > runpaml.job
qsub runpaml.job


##now assemble the results
>orthos.txt; >results.txt; for file in $(ls *.codml); do grep dN\/dS= $file >> results.txt; echo ${file/.codml/} >> orthos.txt; done

##now reformat the results for input into R
reformat_dNdS.py orthos.txt results.txt results_R.txt






##============== RUNNING Alignments and PAML individually ========================================   560
#first align the protein sequences
mafft --auto --maxiterate 1000 Acropora_digitifera_4_prot.fasta > Acropora_digitifera_4_prot.aln
#then extract the codons
pal2nal.pl Acropora_digitifera_4_prot.aln Acropora_digitifera_4.nuc -output paml  -nogap  > Acropora_digitifera_4.codon
codeml Acropora_digitifera_4.cnt
done

##============== RUNNING pal2nal ========================================
pal2nal.pl Acropora_digitifera_4.aln Acropora_digitifera_4.nuc -output paml  -nogap  > Acropora_digitifera_4.codon
cd for_paml/



##now make alignments from each protein fasta
module load mafft
>align; for fa in $(ls *prot.fas); do echo "mafft --auto --maxiterate 1000 $fa > ${fa/.fas/}.aln" >> align; done
GDlauncher_creator.py -j align -n align -l align0.job
cat align0.job | perl -pe 's/12way .+$/12way 48/' > align.job ; rm align0.job
qsub align.job






#Appendix 1:
##------- ALTERNATIVELY, YOU CAN BLAST AGAINST SWISS PROT---------
#this is more complicated since SP is so big, you got to dodge around time constraint for Lonestar
#change the names around a bit to make moving them easier
for file in *.fasta
do mv "$file" "${file/subset1_/s1}" #move the file name to the file name with 'subset1_' replaced with 's1'
done

#blastxing against SP takes forever, so we need to split up the transcriptomes further
for file in $(ls *.fasta)
do
echo splitFasta.pl $file 120
done

#blastx the subsets against the uniprot database
module load blast

#setup the command file
>doblast 
for file in $(ls subset*Adigitifera*)
do
echo blastx -query $file -db $UNIPROT -evalue 1e-5 -num_threads 3 -num_descriptions 5 -num_alignments 5 -out $file.br >> doblast
done

GDlauncher_creator.py -j doblast -n doblast -l doblast0.job -a tagmap -q normal -t 24:00:00
sed 's/12way 120/4way 360/' doblast0.job > doblast.job
rm doblast1.job
qsub doblast.job
##====================================================================




